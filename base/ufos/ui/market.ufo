// ==================
// MARKET MENU
// ==================

component panel cmpMarketItem
{
	{
		size "70 51"
	}
	image bt_buy
	{
		src		"buttons/blue_left"
		pos			"0 0"
		size		"35 51"
		mousefx		true
		onClick		{
			*cvar:tmp = ( <node:parent@num> + <node:root.market@viewpos> )
			cmd "sync_market_scroll <cvar:tmp> <node:root.market@viewpos>; market_click <cvar:tmp>; mn_buy <cvar:tmp>;"
			delete *cvar:tmp
		}
		onMouseEnter { *node:this@image = "buttons/blue_left_hover" }
		onMouseLeave { *node:this@image = "buttons/blue_left" }
	}
	image bt_sell
	{
		src		"buttons/blue_right"
		pos			"35 0"
		size		"35 51"
		mousefx		true
		onClick		{
			*cvar:tmp = ( <node:parent@num> + <node:root.market@viewpos> )
			cmd "sync_market_scroll <cvar:tmp> <node:root.market@viewpos>; market_click <cvar:tmp>; mn_sell <cvar:tmp>;"
			delete *cvar:tmp
		}
		onMouseEnter { *node:this@image = "buttons/blue_right_hover" }
		onMouseLeave { *node:this@image = "buttons/blue_right" }
	}
}

window market extends objectinfo
{
	/** @todo Remove me */
	{ } // empty properties to fix parsing problem with "image" token (behaviour or property?)

	// ==================
	// background
	// ==================

	image background
	{
		src		"background/base_bg"
	}

	cmpBaseHeader baseHeader {
	}

	// ==================
	// tab
	// ==================

	panel tab_background {
		pos		"24 96"
		size	"986 56"
		image	"ui/panel_tab"
	}

	tab market_navigation {
		{
			pos		"47 106"
			size	"938 39"
			cvar	*cvar:mn_itemtype
			onChange {
				cmd "buy_type <cvar:mn_itemtype>;"
			}
		}

		option primary {
			label	"_Primary"
			value	"primary"
		}
		option secondary {
			label	"_Secondary"
			value	"secondary"
		}
		option heavy {
			label	"_Heavy"
			value	"heavy"
		}
		option misc {
			label	"_Misc"
			value	"misc"
		}
		option armour {
			label	"_Armour"
			value	"armour"
		}
		option craftitem {
			label	"_Craft items"
			value	"craftitem"
		}
		option aircraft {
			label	"_Aircraft"
			value	"aircraft"
		}
		option dummy {
			label	"_Other"
			value	"dummy"
		}
		option ugvitem {
			label	"_UGV items"
			value	"ugvitem"
		}
	}

	// ==================
	// lists
	// ==================

	rows lines {
		pos			"28 175"
		size		"530 568"
		color1		"0 0.08 0 1"
		color2		"0 0.16 0 1"
		lineheight	51
	}

	panel verticalline {
		pos		"448 175"
		size	"4 565"
		bgcolor	"0.03 0.42 0.03 1"
	}

	panel itemlist {
		pos		"12 160"
		size	"553 597"
		image	"ui/panel_grey_green_large2"
	}

	textlist market
	{
		dataid		TEXT_MARKET_NAMES
		color		"0 .78 0 1"
		rows		"11"
		lineheight	"51"
		pos			"45 177"
		size		"245 565"
		onChange	{ cmd "sync_market_scroll <lineselected> <viewpos>;market_click <lineselected>;" }
		onWheel		{ cmd "sync_market_scroll <lineselected> <viewpos>;" }
		onViewChange {
			*node:root.market_scrollbar@fullsize = <fullsize>
			*node:root.market_scrollbar@current = <viewpos>
			*node:root.market_scrollbar@viewsize = <viewsize>
			cmd "sync_market_scroll <lineselected> <viewpos>;"
		}
	}

	textlist market_storage
	{
		dataid		TEXT_MARKET_STORAGE
		color		"0 .78 0 1"
		contentalign	ALIGN_CR
		pos			"290 177"
		rows		"11"
		size		"40 565"
		lineheight	"51"
		onChange	{ cmd "sync_market_scroll <lineselected> <viewpos>;market_click <lineselected>;" }
		onWheel		{ cmd "sync_market_scroll <lineselected> <viewpos>;" }
		onViewChange {
			*node:root.market_scrollbar@fullsize = <fullsize>
			*node:root.market_scrollbar@current = <viewpos>
			*node:root.market_scrollbar@viewsize = <viewsize>
			cmd "sync_market_scroll <lineselected> <viewpos>;"
		}
	}

	textlist market_market
	{
		dataid		TEXT_MARKET_MARKET
		color		"0 .78 0 1"
		contentalign	ALIGN_CR
		pos			"406 177"
		rows		"11"
		size		"40 565"
		lineheight	"51"
		onChange	{ cmd "sync_market_scroll <lineselected> <viewpos>;market_click <lineselected>;" }
		onWheel		{ cmd "sync_market_scroll <lineselected> <viewpos>;" }
		onViewChange {
			*node:root.market_scrollbar@fullsize = <fullsize>
			*node:root.market_scrollbar@current = <viewpos>
			*node:root.market_scrollbar@viewsize = <viewsize>
			cmd "sync_market_scroll <lineselected> <viewpos>;"
		}
	}

	textlist market_prices
	{
		dataid		TEXT_MARKET_PRICES
		color		"0 .78 0 1"
		contentalign	ALIGN_CR
		rows		"11"
		size		"80 565"
		lineheight	"51"
		pos			"444 177"
		onChange	{ cmd "sync_market_scroll <lineselected> <viewpos>;market_click <lineselected>;" }
		onWheel		{ cmd "sync_market_scroll <lineselected> <viewpos>;" }
		onViewChange {
			*node:root.market_scrollbar@fullsize = <fullsize>
			*node:root.market_scrollbar@current = <viewpos>
			*node:root.market_scrollbar@viewsize = <viewsize>
			cmd "sync_market_scroll <lineselected> <viewpos>;"
		}
	}

	vscrollbar market_scrollbar {
		image		"ui/scrollbar_v_green"
		pos			"530 175"
		height		"565"
		current		0
		viewsize	13
		fullsize	13
		hidewhenunused true
		onChange	{ cmd "sync_market_scroll <node:root.market@lineselected> <current>;" }
	}

	// ==================
	// buy/sell buttons
	// ==================

	cmpMarketItem item0
	{
		pos			"340 177"
		num			0
	}
	cmpMarketItem item1
	{
		pos			"340 228"
		num			1
	}
	cmpMarketItem item2
	{
		pos			"340 279"
		num			2
	}
	cmpMarketItem item3
	{
		pos			"340 330"
		num			3
	}
	cmpMarketItem item4
	{
		pos			"340 381"
		num			4
	}
	cmpMarketItem item5
	{
		pos			"340 432"
		num			5
	}
	cmpMarketItem item6
	{
		pos			"340 483"
		num			6
	}
	cmpMarketItem item7
	{
		pos			"340 534"
		num			7
	}
	cmpMarketItem item8
	{
		pos			"340 585"
		num			8
	}
	cmpMarketItem item9
	{
		pos			"340 636"
		num			9
	}
	cmpMarketItem item10
	{
		pos			"340 687"
		num			10
	}

	/**
	 * @param <1> item selected
	 * @param <2> scroll position
	 */
	confunc sync_market_scroll {
		*node:root.market@lineselected = <1>
		*node:root.market_storage@lineselected = <1>
		*node:root.market_market@lineselected = <1>
		*node:root.market_prices@lineselected = <1>
		*node:root.market@viewpos = <2>
		*node:root.market_storage@viewpos = <2>
		*node:root.market_market@viewpos = <2>
		*node:root.market_prices@viewpos = <2>
		*node:root.market_scrollbar@fullsize = <node:root.market@fullsize>
		*node:root.market_scrollbar@current = <node:root.market@viewpos>
		*node:root.market_scrollbar@viewsize = <node:root.market@viewsize>
	}

	/**
	 * @note correct current and max values of spinners will be set via confunc
	 * @sa (confunc) buy_updateitem
	 * @sa BS_UpdateItem
	 */

	panel basedescription {
		{
			pos		"588 167"
			size	"410 115"
			image	"ui/panel_grey_green"
		}

		// ==================
		// storage capacity
		// ==================

		string txt_storage_caption
		{
			visiblewhen "*cvar:mn_itemtype ne \"aircraft\""	// for everything except aircraft
			string 		"_Storage (used/all):"
			pos			"62 50"
			size		"200 20"
			font		"f_small"
		}

		string txt_storage_value
		{
			visiblewhen "*cvar:mn_itemtype ne \"aircraft\""	// for everything except aircraft
			string 		*cvar:mn_bs_storage
			pos			"267 50"
			size		"100 20"
			font		"f_small"
		}
	}

	confunc listen_openpedia {
		cmd "market_click <node:root.market@lineselected>;"
		cmd "ui_removelistener ufopedia@onWindowClosed <path:this>;"
	}

	panel itemdescription {
		{
			pos		"588 303"
			size	"410 455"
			image	"ui/panel_grey_green"
		}

		// ==================
		// item description
		// ==================

		string itemname
		{
			visiblewhen "*cvar:mn_itemtype ne \"aircraft\""	// for everything except aircraft
			string		*cvar:mn_itemname
			pos			"22 25"
			size		"365 20"
			contentalign	ALIGN_UC
		}
		string aircraftname
		{
			visiblewhen "*cvar:mn_itemtype eq \"aircraft\""	// Only for aircraft.
			string		*cvar:mn_aircraftname
			pos			"22 25"
			size		"365 20"
			contentalign	ALIGN_UC
		}

		item itemmodel
		{
			src			*cvar:mn_item
			pos			"13 55"
			size		"384 200"
			angles		"-10 160 70"
			omega		"0 10 0"
			autoscale	true
		}

		text description
		{
			dataid		TEXT_ITEMDESCRIPTION
			pos			"32 257"
			size		"336 120"
			rows		"8"
			lineheight	15
			tabwidth	168
			font		"f_verysmall"
			onViewChange {
				*node:root.itemdescription.description_scroll@fullsize = <fullsize>
				*node:root.itemdescription.description_scroll@current = <viewpos>
			}
			onWheel {
				*node:root.itemdescription.description_scroll@current = <viewpos>
			}
		}
		vscrollbar description_scroll {
			image		"ui/scrollbar_v_green"
			pos			"370 257"
			height		"120"
			current		0
			viewsize	8
			fullsize	8
			hidewhenunused true
			onChange {
				*node:root.itemdescription.description@viewpos = <current>
			}
		}

		custombutton ufopedia_link
		{
			icon		"icons/bordered_magnifying_glass"
			tooltip		"_UFOpaedia"
			pos			"336 15"
			size		"60 60"
			stretch		true
			onClick		{
				cmd "ui_addlistener ufopedia@onWindowClosed <path:root>.listen_openpedia;"
				cmd "market_openpedia;"
			}
		}

		checkbox bt_autosell
		{
			current		0
			tooltip		"_Autosell"
			image		"ui/checkbox_blue"
			pos			"12 15"
			size		"60 60"
			onChange	{ cmd "buy_autosell <node:root.market@lineselected>;market_click <node:root.market@lineselected>;" }
		}

		// ======================
		// useable weapon or ammo
		// ======================

		string header_item
		{
			string	"_With:"
			pos		"32 390"
			size	"100 16"
			font	"f_small"
		}

		custombutton action_dec
		{
			pos		"142 390"
			icon	"icons/prev"
			size	"16 16"
			onClick	{ cmd "mn_decreaseitem;" }
		}

		string item_name
		{
			string	*cvar:mn_linkname
			pos		"162 390"
			size	"190 16"
			contentalign	ALIGN_CC
			font	"f_small"
		}

		custombutton action_inc
		{
			pos		"356 390"
			icon	"icons/next"
			size	"16 16"
			onClick	{ cmd "mn_increaseitem;" }
		}

		// ==================
		// firemode
		// ==================

		string header_firemode
		{
			string	"_Firemode:"
			pos		"32 414"
			size	"100 16"
			font	"f_small"
		}

		custombutton firemode_dec
		{
			tooltip "_Previous firemode"
			pos		"142 414"
			icon	"icons/prev"
			size	"16 16"
			onClick	{ cmd "mn_decreasefiremode;" }
		}

		string firemode_name
		{
			string	*cvar:mn_firemodename
			pos		"162 414"
			size	"190 16"
			contentalign	ALIGN_CC
			font	"f_small"
		}

		custombutton firemode_inc
		{
			tooltip "_Next firemode"
			pos		"356 414"
			icon	"icons/next"
			size	"16 16"
			onClick	{ cmd "mn_increasefiremode;" }
		}

	}

	// =========================
	// buy/sell/autosell actions
	// =========================

	/**
	 * @brief checks an autosell checkbox and makes it visible
	 * @param[in] <1> row of item
	 */
	confunc buy_autoselle {
		*node:root.itemdescription.bt_autosell@invis = false
		*node:root.itemdescription.bt_autosell@current = 1
		*node:root.itemdescription.bt_autosell@tooltip = "_Item autosell enabled"
	}
	/**
	 * @brief unchecks an autosell checkbox and makes it visible
	 * @param[in] <1> row of item
	 */
	confunc buy_autoselld {
		*node:root.itemdescription.bt_autosell@invis = false
		*node:root.itemdescription.bt_autosell@current = 0
		*node:root.itemdescription.bt_autosell@tooltip = "_Item autosell disabled"
	}
	/**
	 * @brief makes an autosell checkbox invisible
	 * @param[in] <1> row of item
	 */
	confunc buy_autoselli {
		*node:root.itemdescription.bt_autosell@invis = true
	}

	/**
	 * @brief sets the selected line of the buylist
	 * @param[in] <1> row of the item
	 */
	confunc buy_selectitem {
		*node:root.market@lineselected = <1>
	}

	/**
	 * @brief sets the correct values for spinner controls
	 * @param[in] <1> row of the item
	 * @param[in] <2> quantity of the item in the base
	 * @param[in] <3> min value allowed
	 * @param[in] <4> max value allowed
	 */
	confunc buy_updateitem {
		//*node:root.item<1>.bt_buysell@current = <2>
		//*node:root.item<1>.bt_buysell@min = <3>
		//*node:root.item<1>.bt_buysell@max = <4>
	}

	/**
	 * @brief hides the buy/sell spinner control
	 * @param[in] <1> row of the item
	 */
	confunc buy_hide {
		//*node:root.item<1>.bt_buysell@invis = true
	}
	/**
	 * @brief shows the buy/sell spinner control
	 * @param[in] <1> row of the item
	 */
	confunc buy_show {
		//*node:root.item<1>.bt_buysell@invis = false
	}

	// ==================
	// init
	// ==================

	func onWindowOpened
	{
		cmd "buy_type *cvar:mn_itemtype;"
	}

	func onWindowClosed
	{
		// Call base_init so that storage data can be updated
		cmd "base_init;"
	}
}
